#
**MiFare Classic 1k Smart Card MFOC Nested Attack**

**Disclaimer**

**The below instructions are for EDUCATIONAL purposes only. I am not personally responsible for any illicit or illegal use arising from this repository. By reading this disclaimer, you agree to the responsible use of this repository.**

**Introduction**

The MiFare Classic 1k Smart Card is easily vulnerable to either the Dark-Side Attack using the `MFCUK` tool or the nested attack using the `MFOC` tool. Both tools will enable us to derive the `key A` and `key B` of the MiFare Smart Card, granting the user privileges to write / read data from the data sectors. In this guide, we will use the MFOC tool to perform a nested attack and compromise both `key A` and `key B`

Required Items:

1. Linux Operating System (UBUNTU OS)
2. USB NFC Card Reader (Model: ACR122U)
3. MiFare 1k Classic Smart Card (Our `Target`)
4. Blank Sector 0 Unlocked MiFare Smart Card (Optional - Commonly refered to as Chinese magic cards - Our `Dump`)

**Design Architecture of the MiFare Classic Smart Card**

The MiFare Smart Card is designed with 16 sectors, each cointaining 4 blocks (Block 0, Block 1, Block, 2, Block 3). Sector 0 contains the unique identification of the card, commonly referred to as the manufacturer's block, which will not be writeable due to the security measure of the card.

In each of the 16 sectors, the hex data in each sector is secured with 2 keys - 'key A' and 'key B' respectively. Both keys together form the `security block` of each sector, which is commonly placed in the last block (block 3) in each sector.

**MFOC Attack**

1. Set up a linux or UNIX-like operating system if you do not have any, and perform the following actions to update your machine. I will be using `UBUNTU` for this example. The `sudo` command will give us superuser privileges, AKA 'superuser do', open up your `terminal` to perform the following commands:

```
sudo apt-get update
```
```
sudo apt-get -y install subversion autoconf debhelper flex libusb-dev libpcsclite-dev libpcsclite1 libccid pcscd pcsc-tools libpcsc-perl libusb-1.0-0-dev libtool libssl-dev cmake checkinstall
```
2. Now we need to install the libnfc package for our machine to recognize the card reader. Commands may vary according to the model of your usb card reader. In this example, I'm going to use the ACR122U usb card reader. Please perform the following commands:

```
wget https://github.com/nfc-tools/libnfc/releases/download/libnfc-1.7.0-rc7/libnfc-1.7.0-rc7.tar.gz
```
```
tar -xvzf libnfc-1.7.0-rc7.tar.gz
```
```
cd libnfc-1.7.0-rc7
```
```
./configure --with-drivers=acr122_usb
```
```
make
```
```
sudo make install
```
3. Next, we need to make sure our usb reader is working properly, and we have the capability to read the MiFare Smart Card.
```
sudo nfc-list
```
If there is no errors, and if the UID and data is listed on your terminal, you are good to go, if not you need to perform the following actions:

- if it shows “nfc-list: error while loading shared libraries: libnfc.so.4: cannot open shared object file: No such file or directory”

```
sudo sh -c "echo /usr/local/lib > /etc/ld.so.conf.d/usr-local-lib.conf"
```
```
sudo ldconfig
```
Try again, with ```sudo nfc-list```

-if not If it says “Unable to claim USB interface”, do the following troubleshooting actions

```
sudo nano /etc/modprobe.d/blacklist-libnfc.conf
```
Add the following two lines to the empty file, save (CTRL+O), and exit (CTRL+X):
```
blacklist pn533
blacklist nfc
```
Next, perform this action:
```
sudo modprobe -r pn533 nfc
```
After this, ```sudo nfc-list``` should produce no errors

4. So now, we should have the `libnfc` package installed and ready to go with no errors. The next thing we need to do is to install and configure the `MFOC` attack package. We can do so with the following actions:

```
wget -O mfoc-master.zip https://github.com/nfc-tools/mfoc/archive/master.zip
```
```
unzip mfoc-master.zip
```
```
cd mfoc-master/
```
```
autoreconf -vis
```
```
./configure
```
```
make
```
```
sudo make install
```
5. With the `MFOC` installed on your machine, we can now perform the `nested` attack, in this example, we will clone our `target` and dump it into `dump`, all `MFOC` attacks should be done in the `mfoc-master` directory:

Place your `target` onto the card reader
```
sudo mfoc -P 500 -O target.dmp
```
Both `Key A` and `Key B` should be compromised.

Place your `dump` onto the card reader and then we write the data from our `Target`
```
sudo mfoc -O dump.dmp
sudo nfc-mfclassic W B target.dmp dump.dmp
```
**DONE!**

**Another Way for us to Manipulate the Data**

Another way for us to manipulate and exploit the keys is to change the existing data on our `target`. This can be achieved by downloading the `mifare classic tool apk` on the `Play Store`. We just have to place our `target` on any nfc-enabled android phones, input both `key A` and `key B` onto the keys file on the application, and read the tag.

We can then easily view and exploit the `value-blocks` on the card, usually located in sector 1 or sector 2 of the card. For this example, I have successfully manipulated Sector 2 Block 1 of our `target`, by writing a new `block 1` in sector 2 using the encoding/decoding feature that is avaliable in the app.

Keep in mind that each sector contains 4 blocks, however the very top block of the sector is commonly referred to as `Block 0`, please do not re-write `Block 3` of the sector as you will be re-writing the security keys of the sector. This action will render your data on the `target` irreverssibly corrupted and damaged.

`That's all Folks`
